<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<script src="http://code.jquery.com/jquery-1.10.2.js"></script> 
	<link rel="stylesheet" href="./files/CSS/styles.css">

		
	<title> Chang Map_Area </title>
	<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0caed26006cd55ea65ee44c2d994f012&libraries=clusterer,services"></script>
</head>

<body>
	<!-- ì§€ë„ -->
	<div id="map"></div>

	<!-- ì§€ì—­ ì„ íƒ UI -->
	<div id="regionContainer">
		<h4>ì§€ì—­ ì„ íƒ</h4>
		<button onclick="selectAll(true)">ì „ì²´ ì„ íƒ</button>
		<button onclick="selectAll(false)">RESET</button>
		<div id="regionList">
	        <!-- ì²´í¬ë°•ìŠ¤ ì¶”ê°€ë¨ -->
    	</div>
	</div>

	<script>

	let map;
	let polygons = {}; // h_codeë³„ ë‹¤ê°í˜• ì €ì¥ (ë°°ì—´)

	async function loadRegions() {
    	try {
        	const response = await fetch('./data/region_info_kr.json'); // JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        	const regions = await response.json(); // JSON ë°ì´í„° ë³€í™˜
	        const container = document.getElementById('regionList');

    	    regions.forEach(region => {
	            const regionWrapper = document.createElement('div');
	            regionWrapper.classList.add('region-wrapper');
regionWrapper.dataset.name = region.region_name || ""; // ê°’ì´ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´

	            const regionItem = document.createElement('div');
	            const checkbox = document.createElement('input');
				const regionLabel = document.createElement('span');
				const toggleButton = document.createElement('button');
	            const subRegionContainer = document.createElement('div');
    	        const controlButtons = document.createElement('div');
        	    const selectAllButton = document.createElement('button');
	            const clearButton = document.createElement('button');
            
	            checkbox.type = 'checkbox';
	            checkbox.value = region.h_code;
	            checkbox.name = 'regions';
	            checkbox.classList.add('parent-region');
	            checkbox.addEventListener('change', (event) => {
	                event.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
	                toggleRegion(checkbox);
	            });

				regionLabel.textContent = region.region_name;
				regionLabel.classList.add('region-label');
				regionLabel.style.textDecoration = 'underline';
				regionLabel.style.cursor = 'pointer';
regionLabel.addEventListener('click', () => {
    checkbox.checked = !checkbox.checked;
    toggleRegion(checkbox);
});

		        toggleButton.textContent = 'â–¼';
	            toggleButton.classList.add('toggle-button');
	            toggleButton.style.cursor = 'pointer';
	            toggleButton.style.fontSize = '12px'; // ë²„íŠ¼ í¬ê¸° ì¡°ì •
	            toggleButton.style.marginLeft = '3px';
	            toggleButton.addEventListener('click', (event) => {
	                event.stopPropagation(); // ì²´í¬ë°•ìŠ¤ì™€ ë¶„ë¦¬ëœ ë™ì‘ ìœ ì§€
	                const isVisible = subRegionContainer.style.display === 'block';
	                subRegionContainer.style.display = isVisible ? 'none' : 'block';
	                toggleButton.textContent = isVisible ? 'â–¼' : 'â–²';
	            });

				regionItem.classList.add('region-item');
				// ìˆœì„œ ì¡°ì •: ì²´í¬ë°•ìŠ¤ â†’ ë¶€ëª¨ ì§€ì—­ëª… â†’ í¼ì¹˜ê¸° ë²„íŠ¼
				regionItem.appendChild(checkbox);
				regionItem.appendChild(regionLabel);
				regionItem.appendChild(toggleButton);
            
	            subRegionContainer.classList.add('sub-region-container');
	            subRegionContainer.style.display = 'none'; // ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬
	            subRegionContainer.style.paddingLeft = '20px'; // ë“¤ì—¬ì“°ê¸° ì ìš©
            
	            controlButtons.classList.add('control-buttons');
	            selectAllButton.textContent = 'Select All';
	            selectAllButton.classList.add('select-all-button');
	            selectAllButton.addEventListener('click', () => {
	                toggleSubRegions(subRegionContainer, true);
	            });
            
	            clearButton.textContent = 'ì§€ì—­ ì „ì²´ í•´ì œ';
	            clearButton.classList.add('clear-button');
//	            clearButton.style.display = 'none';
	            clearButton.addEventListener('click', () => {
	                toggleSubRegions(subRegionContainer, false);
	            });

	            controlButtons.appendChild(selectAllButton);
	            controlButtons.appendChild(clearButton);

	            regionWrapper.appendChild(regionItem);
	            regionWrapper.appendChild(subRegionContainer);
	            container.appendChild(regionWrapper);

	            if (region.sub_regions && Array.isArray(region.sub_regions)) {
					subRegionContainer.appendChild(controlButtons); // ë²„íŠ¼ì„ ë¨¼ì € ì¶”ê°€

		            region.sub_regions.forEach(subRegion => {
	                    const subRegionItem = document.createElement('div');
	                    const subCheckbox = document.createElement('input');
	                    const subLabel = document.createElement('span');

subRegionItem.dataset.name = subRegion.region_name || ""; // í•˜ìœ„ ì§€ì—­ì—ë„ ë°ì´í„°ì…‹ ì¶”ê°€


	                    subCheckbox.type = 'checkbox';
	                    subCheckbox.value = subRegion.h_code;
	                    subCheckbox.name = 'regions';
	                    subCheckbox.classList.add('sub-region');
	                    subCheckbox.addEventListener('change', (event) => {
	                        event.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
	                        toggleRegion(subCheckbox);
	                    });
                    
    	                subLabel.textContent = subRegion.region_name;
        	            subLabel.classList.add('sub-region-label');
                    subLabel.style.cursor = 'pointer';
subLabel.addEventListener('click', () => {
    subCheckbox.checked = !subCheckbox.checked;
    toggleRegion(subCheckbox);
});
	                    subRegionItem.appendChild(subCheckbox);
    	                subRegionItem.appendChild(subLabel);
        	            subRegionItem.classList.add('sub-region-item');
            	        subRegionItem.style.paddingLeft = '20px'; // ë“¤ì—¬ì“°ê¸° ì ìš©
                    
	                    subRegionContainer.appendChild(subRegionItem);
    	            });
	            }
	        });
	    } catch (error) {
	        console.error('ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
	    } // try
	} // function loadRegions()

function toggleRegion(checkbox) {
    const hcode = checkbox.value;
    if (checkbox.checked) {
        if (!polygons[hcode]) {
            fetchRegionData(hcode);
        }
    } else {
        removePolygon(hcode);
    }
}

function toggleSubRegions(container, select) {
    const subCheckboxes = container.querySelectorAll('input.sub-region');
    subCheckboxes.forEach(checkbox => {
        checkbox.checked = select;
        toggleRegion(checkbox);
    });
    const clearButton = container.querySelector('.clear-button');
    const selectAllButton = container.querySelector('.select-all-button');
/*    if (select) {
        clearButton.style.display = 'block';
        selectAllButton.style.display = 'none';
    } else {
        clearButton.style.display = 'none';
        selectAllButton.style.display = 'block';
    }*/
}

function selectAll(select) {
    const parentCheckboxes = document.querySelectorAll('input.parent-region');
    parentCheckboxes.forEach(checkbox => {
        const wasChecked = checkbox.checked;
        checkbox.checked = select;

        if (select && !wasChecked) {
            fetchRegionData(checkbox.value); // ìƒˆë¡œ ì„ íƒëœ ê²½ìš°ë§Œ ìš”ì²­
        } else if (!select) {
            removePolygon(checkbox.value);

        }
    });
    
    if (!select) {
        const subCheckboxes = document.querySelectorAll('input.sub-region');
        subCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            toggleRegion(checkbox);
        });
        
        const subRegionContainers = document.querySelectorAll('.sub-region-container');
        subRegionContainers.forEach(container => {
            container.style.display = 'none'; // ì „ì²´ í•´ì œ ì‹œ ëª¨ë“  í•˜ìœ„ ì§€ì—­ ë‹«ê¸°
        });
        
            const toggleButtons = document.querySelectorAll('.toggle-button');
    toggleButtons.forEach(button => {
        button.textContent = 'â–¼'; // ì „ì²´ í•´ì œ ì‹œ ëª¨ë“  í† ê¸€ ë²„íŠ¼ ì´ˆê¸°í™”
    });
    
            map.setCenter(new kakao.maps.LatLng(37.39541713271851, 127.11036420512991));
            map.setLevel(13);
    }
}

function filterRegions() {
    const query = document.getElementById('regionSearch').value.toLowerCase();
    const isEmpty = query.trim() === ''; // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸

    document.querySelectorAll('.region-wrapper').forEach(wrapper => {
        const regionName = wrapper.dataset.name.toLowerCase();
        let match = regionName.includes(query);

        const subRegionContainer = wrapper.querySelector('.sub-region-container');
        const toggleButton = wrapper.querySelector('.toggle-button');
        let hasVisibleSubRegion = false;

        const subRegions = wrapper.querySelectorAll('.sub-region-item');
        subRegions.forEach(subRegion => {
            const subName = subRegion.dataset.name.toLowerCase();
            const subMatch = subName.includes(query);
            subRegion.style.display = subMatch ? 'block' : 'none';
            if (subMatch) hasVisibleSubRegion = true;
        });

        if (match || hasVisibleSubRegion) {
            wrapper.style.display = 'block';
            if (hasVisibleSubRegion) {
                subRegionContainer.style.display = 'block';
                toggleButton.textContent = 'â–²';
            }
        } else {
            wrapper.style.display = 'none';
        }

        // ğŸ”¹ ê²€ìƒ‰ì–´ê°€ ë¹„ì—ˆì„ ë•Œ í•˜ìœ„ ì§€ì—­ ë‹«ê¸°
        if (isEmpty) {
            subRegionContainer.style.display = 'none';
            toggleButton.textContent = 'â–¼';
        }
    });
}

function fetchRegionData(hcode) {
	console.log("fetchRegionData")

    const apiUrl = `./proxy.php?hcode=${hcode}`;

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                removePolygon(hcode);
                polygons[hcode] = [];

                data.forEach(region => {
                    if (region.exterior && Array.isArray(region.exterior)) {
                        const polygonPath = region.exterior.map(coord => 
                            new kakao.maps.LatLng(coord.y, coord.x)
                        );
                        drawPolygon(hcode, polygonPath);
                    }
                });
            }
        })
        .catch(error => console.error(`API í˜¸ì¶œ ì˜¤ë¥˜ (h_code: ${hcode}):`, error));
}

function drawPolygon(hcode, polygonPath) {
	console.log("drawPolygon")

    const polygon = new kakao.maps.Polygon({
        path: polygonPath,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.5,
        fillColor: '#FF0000',
        fillOpacity: 0.1
    });

    polygon.setMap(map);
    polygons[hcode].push(polygon);
    adjustMapBounds();
}

function adjustMapBounds() {
	console.log("adjustMapBounds")
    const bounds = new kakao.maps.LatLngBounds();
    Object.values(polygons).forEach(polygonArray => {
        polygonArray.forEach(polygon => {
            polygon.getPath().forEach(coord => bounds.extend(coord));
        });
    });
    if (!bounds.isEmpty()) {
        map.setBounds(bounds);
    }
}

function removePolygon(hcode) {
	console.log("removePolygon")

    if (polygons[hcode]) {
        polygons[hcode].forEach(polygon => polygon.setMap(null));
        delete polygons[hcode];
    }
//    adjustMapBounds();
}

function initMap() {
    map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.39541713271851, 127.11036420512991),
        level: 13
    });
}


document.addEventListener("DOMContentLoaded", () => {

    const searchContainer = document.createElement('div');
    searchContainer.style.position = 'relative';
    searchContainer.style.display = 'inline-block';
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.id = 'regionSearch';
    searchInput.placeholder = 'ì§€ì—­ ê²€ìƒ‰';
    searchInput.addEventListener('input', filterRegions);
    
    const clearButton = document.createElement('button');
    clearButton.textContent = 'x';
    clearButton.style.position = 'absolute';
    clearButton.style.right = '5px';
    clearButton.style.top = '50%';
    clearButton.style.transform = 'translateY(-50%)';
    clearButton.style.border = 'none';
    clearButton.style.background = 'transparent';
    clearButton.style.cursor = 'pointer';
    clearButton.style.display = 'none'; // ì²˜ìŒì—ëŠ” ìˆ¨ê¹€

    clearButton.addEventListener('click', () => {
        searchInput.value = '';
        filterRegions(); // ê²€ìƒ‰ì–´ ì§€ìš°ë©´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
        clearButton.style.display = 'none';
    });    

    searchInput.addEventListener('input', () => {
        clearButton.style.display = searchInput.value ? 'block' : 'none';
    });

    searchContainer.appendChild(searchInput);
    searchContainer.appendChild(clearButton);
    document.getElementById('regionContainer').insertBefore(searchContainer, document.getElementById('regionList'));


    initMap();
    loadRegions();

    // âœ… ì§€ì—­ ì„ íƒ ì»¨í…Œì´ë„ˆ í† ê¸€ ë²„íŠ¼ ì¶”ê°€
    const regionContainer = document.getElementById('regionContainer');
    const toggleRegionContainerBtn = document.createElement('button');
    toggleRegionContainerBtn.textContent = 'ì ‘ê¸° â–²';
    toggleRegionContainerBtn.classList.add('toggle-region-container-btn');
    
    toggleRegionContainerBtn.addEventListener('click', () => {
        const isVisible = regionContainer.style.display !== 'none';
        regionContainer.style.display = isVisible ? 'none' : 'block';
        toggleRegionContainerBtn.textContent = isVisible ? 'í¼ì¹˜ê¸° â–¼' : 'ì ‘ê¸° â–²';
    });

    // ì»¨í…Œì´ë„ˆ ì•ì— ë²„íŠ¼ ì¶”ê°€
    regionContainer.parentElement.insertBefore(toggleRegionContainerBtn, regionContainer);
});


</script>
</body>


</html>
